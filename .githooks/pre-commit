#!/bin/bash
# Pre-commit hook to check for sensitive data before committing

echo "üîç Running pre-commit security checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úì${NC} No files staged"
    exit 0
fi

# Check for .env files (should never be committed)
ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env$|\.env\.local$' | grep -v '\.env\.example$' || true)
if [ -n "$ENV_FILES" ]; then
    echo -e "${RED}‚ùå ERROR: Attempting to commit .env files:${NC}"
    echo "$ENV_FILES"
    ERRORS=1
fi

# Check for potential secrets in staged files
check_secrets() {
    local file=$1
    
    # Skip binary files and certain paths
    if [[ "$file" == *.png ]] || [[ "$file" == *.jpg ]] || [[ "$file" == *.gif ]] || \
       [[ "$file" == *.ico ]] || [[ "$file" == *.pdf ]] || [[ "$file" == package-lock.json ]]; then
        return 0
    fi
    
    # Get staged content
    local content=$(git show ":$file" 2>/dev/null || true)
    
    if [ -z "$content" ]; then
        return 0
    fi
    
    # Patterns to check (excluding known development values)
    local patterns=(
        'sk-[a-zA-Z0-9]{20,}'                    # OpenAI API keys
        'sk-ant-[a-zA-Z0-9\-_]{20,}'             # Anthropic API keys
        'AKIA[0-9A-Z]{16}'                        # AWS Access Key ID
        'gh[pousr]_[A-Za-z0-9_]{36,}'            # GitHub tokens
        '-----BEGIN.*PRIVATE KEY-----'            # Private keys
    )
    
    for pattern in "${patterns[@]}"; do
        if echo "$content" | grep -qE "$pattern"; then
            echo -e "${RED}‚ùå Potential secret found in: $file${NC}"
            echo "   Pattern: $pattern"
            ERRORS=1
        fi
    done
}

echo "Checking staged files for secrets..."
for file in $STAGED_FILES; do
    check_secrets "$file"
done

# Check for large files that might be data dumps
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo "0")
        if [ "$SIZE" -gt 1000000 ]; then  # 1MB
            echo -e "${YELLOW}‚ö†Ô∏è  Warning: Large file (>1MB): $file${NC}"
        fi
    fi
done

if [ $ERRORS -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå Pre-commit check failed!${NC}"
    echo "   Please remove sensitive data before committing."
    echo "   To bypass this check (not recommended): git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}‚úì${NC} Pre-commit security check passed"
exit 0

